<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Join Quest - Quests</title>
    <meta name="description" content="You've been invited to a Quest. Preview and join on Quests." />
    <meta name="robots" content="noindex" />
    <meta name="theme-color" content="#0d1f3a" />
    <meta name="apple-itunes-app" content="app-id=6745767553" />

    <!-- Open Graph -->
    <meta property="og:title" content="You're invited to a Quest!" />
    <meta property="og:description" content="Join your friend's quest on Quests - the social habit tracking app" />
    <meta property="og:image" content="https://invite.thequestsapp.com/icon.png" />
    <meta property="og:url" content="https://invite.thequestsapp.com/q/" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Quests" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="You're invited to a Quest!" />
    <meta name="twitter:description" content="Join your friend's quest on Quests - the social habit tracking app" />
    <meta name="twitter:image" content="https://invite.thequestsapp.com/icon.png" />

    <link rel="icon" type="image/png" href="/icon.png" />
    <link rel="apple-touch-icon" href="/icon.png" />
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@600;700;800&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <style>
      /* ========================================
         CSS Variables — Quests brand tokens
         ======================================== */
      :root {
        color-scheme: dark;

        /* Core palette */
        --blue-900: #04102a;
        --blue-800: #14213c;
        --blue-700: #21458e;
        --blue-500: #3366cc;
        --blue-400: #5c85d6;
        --blue-300: #6688ee;
        --accent: #3366cc;
        --accent-light: #5c85d6;
        --accent-lighter: #6688ee;
        --accent-success: #34c759;
        --accent-warning: #ff9f0a;
        --accent-error: #ff453a;

        /* Text */
        --text-strong: #ffffff;
        --text-muted: #a7b1d0;
        --text-soft: rgba(167, 177, 208, 0.6);

        /* Surfaces */
        --surface-strong: rgba(32, 44, 79, 0.92);
        --surface-medium: rgba(32, 44, 79, 0.78);
        --surface-soft: rgba(32, 44, 79, 0.6);
        --glass: rgba(32, 44, 79, 0.68);

        /* Borders */
        --border-strong: rgba(48, 61, 98, 0.95);
        --border-soft: rgba(48, 61, 98, 0.6);
        --border-accent: rgba(92, 133, 214, 0.35);

        /* Shadows */
        --shadow-lg: 0 40px 90px -35px rgba(4, 16, 42, 0.7);
        --shadow-md: 0 24px 60px -30px rgba(6, 22, 58, 0.55);
        --shadow-sm: 0 12px 36px -22px rgba(9, 24, 54, 0.45);

        /* Layout */
        --page-max: 480px;
        --page-pad: 20px;
        --card-radius: 24px;
        --card-radius-sm: 16px;
        --pill-radius: 999px;

        /* Shimmer */
        --shimmer-base: rgba(32, 44, 79, 0.6);
        --shimmer-highlight: rgba(48, 61, 98, 0.8);
      }

      /* ========================================
         Reset & Base
         ======================================== */
      *, *::before, *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html {
        -webkit-text-size-adjust: 100%;
      }

      body {
        font-family: "Manrope", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text-strong);
        background: var(--blue-900);
        min-height: 100vh;
        min-height: 100dvh;
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      a:visited {
        color: inherit;
      }

      a:hover {
        filter: brightness(1.05);
      }

      /* ========================================
         Background — matches main site
         ======================================== */
      .page-bg {
        position: fixed;
        inset: 0;
        z-index: -1;
        background:
          radial-gradient(circle at 20% 20%, rgba(92, 133, 214, 0.1), transparent 55%),
          radial-gradient(circle at 78% -10%, rgba(102, 136, 238, 0.08), transparent 45%),
          linear-gradient(145deg, var(--blue-900) 0%, var(--blue-800) 60%, #1a3a7d 100%);
      }

      .page-bg::after {
        content: "";
        position: fixed;
        inset: 0;
        background:
          radial-gradient(circle at 25% 15%, rgba(70, 108, 214, 0.16), transparent 55%),
          radial-gradient(circle at 85% 25%, rgba(76, 132, 255, 0.12), transparent 45%);
        pointer-events: none;
      }

      /* ========================================
         Page wrapper — single-column centered
         ======================================== */
      .page {
        position: relative;
        width: 100%;
        min-height: 100vh;
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
      }

      /* ========================================
         Header — brand bar
         ======================================== */
      .site-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        margin: 0;
        padding: 20px clamp(24px, 5vw, 64px);
        gap: 24px;
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        backdrop-filter: blur(18px);
        background: linear-gradient(180deg, rgba(4, 16, 42, 0.88) 0%, rgba(4, 16, 42, 0) 100%);
        border-radius: 0 0 24px 24px;
        box-shadow: var(--shadow-sm);
        z-index: 20;
      }

      .site-header__inner {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        line-height: normal;
      }

      .brand {
        display: inline-flex;
        align-items: center;
        gap: 14px;
        text-decoration: none;
        color: var(--text-strong);
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-weight: 700;
        letter-spacing: -0.02em;
        line-height: normal;
      }

      .brand__glyph {
        width: 38px;
        height: 38px;
        display: inline-block;
        background-color: var(--text-strong);
        mask-image: url("/Quests%20Logo.svg");
        mask-size: contain;
        mask-position: center;
        mask-repeat: no-repeat;
        -webkit-mask-image: url("/Quests%20Logo.svg");
        -webkit-mask-size: contain;
        -webkit-mask-position: center;
        -webkit-mask-repeat: no-repeat;
        filter: drop-shadow(0 10px 22px rgba(4, 16, 42, 0.4));
      }

      .brand__name {
        font-size: 1.4rem;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-weight: 800;
        letter-spacing: -0.03em;
        line-height: 1;
        text-rendering: geometricPrecision;
      }

      .download-chip {
        padding: 12px 20px;
        border-radius: var(--pill-radius);
        border: 1px solid var(--border-strong);
        background: var(--surface-medium);
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.22em;
        line-height: normal;
        box-shadow: var(--shadow-sm);
        transition: transform 0.25s ease, background 0.25s ease, box-shadow 0.25s ease;
        -webkit-tap-highlight-color: transparent;
        outline: none;
      }

      .download-chip:visited {
        color: inherit;
      }

      .download-chip:hover,
      .download-chip:focus-visible {
        background: rgba(51, 102, 204, 0.18);
        border-color: var(--accent);
        box-shadow: 0 18px 42px -22px rgba(4, 16, 42, 0.7);
        transform: translateY(-2px);
      }

      .download-chip:active {
        transform: translateY(0);
      }

      /* ========================================
         Content area — grows to fill
         ======================================== */
      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding-bottom: 40px;
        width: 100%;
        max-width: var(--page-max);
        margin: 0 auto;
        padding-left: var(--page-pad);
        padding-right: var(--page-pad);
      }

      /* ========================================
         State management — show/hide sections
         ======================================== */
      .state-hidden {
        display: none !important;
      }

      /* ========================================
         LOADING STATE — skeleton shimmer
         ======================================== */
      #quest-loading {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding-top: 24px;
      }

      .skeleton {
        border-radius: var(--card-radius-sm);
        background: linear-gradient(
          90deg,
          var(--shimmer-base) 25%,
          var(--shimmer-highlight) 50%,
          var(--shimmer-base) 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.8s ease-in-out infinite;
      }

      @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }

      .skeleton--icon {
        width: 80px;
        height: 80px;
        border-radius: 22px;
        margin: 0 auto 8px;
      }

      .skeleton--title {
        width: 65%;
        height: 28px;
        margin: 0 auto;
        border-radius: 8px;
      }

      .skeleton--text {
        width: 85%;
        height: 16px;
        margin: 0 auto;
        border-radius: 6px;
      }

      .skeleton--text-short {
        width: 55%;
        height: 14px;
        margin: 0 auto;
        border-radius: 6px;
      }

      .skeleton--card {
        width: 100%;
        height: 120px;
        border-radius: var(--card-radius);
      }

      .skeleton--row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0 4px;
      }

      .skeleton--circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .skeleton--line {
        height: 14px;
        border-radius: 6px;
        flex: 1;
      }

      .skeleton--button {
        width: 100%;
        height: 52px;
        border-radius: var(--pill-radius);
        margin-top: 8px;
      }

      .skeleton-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* ========================================
         QUEST CONTENT — main wrapper
         ======================================== */
      #quest-content {
        display: flex;
        flex-direction: column;
        gap: 0;
        padding-top: 8px;
        animation: fadeInUp 0.5s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ========================================
         HERO — icon, title, description
         ======================================== */
      #quest-hero {
        text-align: center;
        padding: 16px 0 20px;
      }

      .quest-icon {
        width: 88px;
        height: 88px;
        margin: 0 auto 16px;
        border-radius: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 44px;
        line-height: 1;
        background: linear-gradient(145deg, rgba(64, 92, 182, 0.28), rgba(11, 24, 56, 0.9));
        border: 1px solid var(--border-accent);
        box-shadow:
          0 20px 50px -25px rgba(4, 16, 42, 0.9),
          inset 0 0 24px rgba(66, 104, 210, 0.18);
        position: relative;
      }

      .quest-icon::after {
        content: "";
        position: absolute;
        inset: -10px;
        border-radius: 32px;
        background: radial-gradient(circle, rgba(80, 120, 255, 0.2), transparent 65%);
        z-index: -1;
      }

      .quest-title {
        font-family: "Bricolage Grotesque", sans-serif;
        font-size: 1.6rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        line-height: 1.2;
        margin: 0 0 10px;
        color: var(--text-strong);
      }

      .quest-description {
        font-size: 0.95rem;
        color: var(--text-muted);
        line-height: 1.6;
        margin: 0;
      }

      /* ========================================
         STATUS BADGE
         ======================================== */
      #quest-status {
        display: flex;
        justify-content: center;
        padding: 12px 0 4px;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 7px;
        padding: 6px 16px;
        border-radius: var(--pill-radius);
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .status-badge--active {
        background: rgba(52, 199, 89, 0.15);
        color: var(--accent-success);
        border: 1px solid rgba(52, 199, 89, 0.3);
      }

      .status-badge--active .status-badge__dot {
        background: var(--accent-success);
        box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.55);
        animation: pulse-dot 1.9s infinite;
      }

      .status-badge--upcoming {
        background: rgba(255, 159, 10, 0.15);
        color: var(--accent-warning);
        border: 1px solid rgba(255, 159, 10, 0.3);
      }

      .status-badge--upcoming .status-badge__dot {
        background: var(--accent-warning);
      }

      .status-badge--ended {
        background: rgba(167, 177, 208, 0.1);
        color: var(--text-soft);
        border: 1px solid var(--border-soft);
      }

      .status-badge--ended .status-badge__dot {
        background: var(--text-soft);
      }

      .status-badge__dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
      }

      /* ========================================
         META — date, duration, frequency cards
         ======================================== */
      #quest-meta {
        display: flex;
        flex-direction: column;
        gap: 1px;
        background: var(--border-soft);
        border-radius: var(--card-radius);
        overflow: hidden;
        margin: 16px 0;
        border: 1px solid var(--border-soft);
      }

      .meta-row {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 18px;
        background: var(--surface-medium);
      }

      .meta-row__icon {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        background: rgba(51, 102, 204, 0.12);
        color: var(--accent-light);
        font-size: 18px;
        flex-shrink: 0;
      }

      .meta-row__text {
        flex: 1;
        min-width: 0;
      }

      .meta-row__label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-soft);
        margin-bottom: 2px;
      }

      .meta-row__value {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-strong);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* ========================================
         CREATOR — avatar + name
         ======================================== */
      #quest-creator {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 0;
      }

      .creator-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--surface-strong);
        border: 2px solid var(--border-soft);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        flex-shrink: 0;
      }

      .creator-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .creator-avatar__fallback {
        font-size: 18px;
        color: var(--text-muted);
      }

      .creator-info {
        flex: 1;
        min-width: 0;
      }

      .creator-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-soft);
        margin-bottom: 1px;
      }

      .creator-name {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-strong);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* ========================================
         SOCIAL — participant count + avatars
         ======================================== */
      #quest-social {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 18px;
        border-radius: var(--card-radius-sm);
        background: var(--surface-soft);
        border: 1px solid var(--border-soft);
        margin-bottom: 20px;
      }

      .social-avatars {
        display: flex;
        align-items: center;
        flex-shrink: 0;
      }

      .social-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--surface-strong);
        border: 2px solid var(--blue-800);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: var(--text-muted);
        overflow: hidden;
      }

      .social-avatar + .social-avatar {
        margin-left: -8px;
      }

      .social-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .social-text {
        font-size: 0.85rem;
        color: var(--text-muted);
      }

      .social-text strong {
        color: var(--text-strong);
        font-weight: 600;
      }

      /* ========================================
         Divider
         ======================================== */
      .divider {
        height: 1px;
        background: var(--border-soft);
        margin: 4px 0;
      }

      /* ========================================
         PHONE GATE — phone input area
         ======================================== */
      #phone-gate {
        padding: 24px 0;
        animation: fadeInUp 0.4s ease-out;
      }

      .gate-card {
        padding: 24px;
        border-radius: var(--card-radius);
        background: var(--surface-strong);
        border: 1px solid var(--border-strong);
        backdrop-filter: blur(20px);
        box-shadow: var(--shadow-md);
      }

      .gate-title {
        font-family: "Bricolage Grotesque", sans-serif;
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0 0 6px;
        color: var(--text-strong);
      }

      .gate-subtitle {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin: 0 0 20px;
        line-height: 1.5;
      }

      .phone-input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
      }

      .phone-input {
        flex: 1;
        padding: 14px 16px;
        border-radius: 14px;
        border: 1px solid var(--border-strong);
        background: var(--surface-medium);
        color: var(--text-strong);
        font-family: inherit;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.2s ease;
      }

      .phone-input::placeholder {
        color: var(--text-soft);
      }

      .phone-input:focus {
        border-color: var(--accent-light);
        box-shadow: 0 0 0 3px rgba(92, 133, 214, 0.15);
      }

      .phone-submit {
        padding: 14px 22px;
        border-radius: 14px;
        border: none;
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
        color: var(--text-strong);
        font-family: inherit;
        font-size: 0.9rem;
        font-weight: 700;
        cursor: pointer;
        white-space: nowrap;
        transition: transform 0.2s ease, filter 0.2s ease;
        flex-shrink: 0;
      }

      .phone-submit:hover:not(:disabled) {
        transform: translateY(-1px);
        filter: brightness(1.08);
      }

      .phone-submit:active:not(:disabled) {
        transform: translateY(0);
      }

      .phone-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .gate-privacy {
        font-size: 0.75rem;
        color: var(--text-soft);
        line-height: 1.5;
        margin: 0;
      }

      .gate-success {
        text-align: center;
        padding: 8px 0;
      }

      .gate-success__icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 12px;
        border-radius: 50%;
        background: rgba(52, 199, 89, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: var(--accent-success);
      }

      .gate-success__title {
        font-family: "Bricolage Grotesque", sans-serif;
        font-size: 1rem;
        font-weight: 700;
        margin: 0 0 6px;
        color: var(--text-strong);
      }

      .gate-success__text {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin: 0;
        line-height: 1.5;
      }

      /* ========================================
         INSTALL HANDOFF — download CTA
         ======================================== */
      #install-handoff {
        padding: 8px 0 24px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .cta-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 16px 28px;
        border-radius: 20px;
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
        color: var(--text-strong);
        font-family: inherit;
        font-size: 1rem;
        font-weight: 600;
        text-decoration: none;
        text-align: center;
        border: none;
        cursor: pointer;
        box-shadow: var(--shadow-lg);
        transition: transform 0.25s ease, box-shadow 0.25s ease, filter 0.25s ease;
      }

      .cta-button:hover {
        transform: translateY(-4px);
        box-shadow: 0 46px 95px -32px rgba(4, 16, 42, 0.75);
      }

      .cta-button:active {
        transform: translateY(0);
      }

      .cta-button__icon {
        font-size: 18px;
        line-height: 1;
      }

      .link-secondary {
        display: block;
        text-align: center;
        font-size: 0.85rem;
        color: var(--text-muted);
        text-decoration: none;
        padding: 8px;
        border-radius: 12px;
        transition: color 0.2s ease;
        cursor: pointer;
        background: none;
        border: none;
        font-family: inherit;
        width: 100%;
      }

      .link-secondary:hover {
        color: var(--accent-light);
      }

      /* ========================================
         ERROR STATE
         ======================================== */
      #quest-error {
        text-align: center;
        padding: 60px 20px;
        animation: fadeInUp 0.4s ease-out;
      }

      .error-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 20px;
        border-radius: 50%;
        background: rgba(255, 69, 58, 0.12);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
      }

      .error-title {
        font-family: "Bricolage Grotesque", sans-serif;
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0 0 8px;
        color: var(--text-strong);
      }

      .error-text {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin: 0 0 28px;
        line-height: 1.6;
      }

      /* ========================================
         QUEST ENDED STATE
         ======================================== */
      #quest-ended {
        text-align: center;
        padding: 24px;
        border-radius: var(--card-radius);
        background: var(--surface-medium);
        border: 1px solid var(--border-soft);
        margin: 8px 0 20px;
      }

      .ended-icon {
        font-size: 32px;
        margin-bottom: 10px;
      }

      .ended-title {
        font-family: "Bricolage Grotesque", sans-serif;
        font-size: 1rem;
        font-weight: 700;
        margin: 0 0 6px;
        color: var(--text-strong);
      }

      .ended-text {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin: 0;
        line-height: 1.5;
      }

      /* ========================================
         Footer
         ======================================== */
      .footer {
        text-align: center;
        padding: 20px 0;
        flex-shrink: 0;
        width: 100%;
        max-width: var(--page-max);
        margin: 0 auto;
        padding-left: var(--page-pad);
        padding-right: var(--page-pad);
      }

      .footer__text {
        font-size: 11px;
        color: var(--text-soft);
        letter-spacing: 0.08em;
      }

      .footer__link {
        color: var(--text-soft);
        text-decoration: none;
        transition: color 0.2s ease;
      }

      .footer__link:hover {
        color: var(--text-muted);
      }

      @media (max-width: 960px) {
        .site-header {
          padding: 18px clamp(20px, 6vw, 40px);
          border-radius: 0 0 20px 20px;
        }

        .site-header__inner {
          width: 100%;
          flex-wrap: wrap;
          gap: 16px;
        }
      }

      /* ========================================
         Responsive — mobile small (match main site ≤640px)
         ======================================== */
      @media (max-width: 640px) {
        .site-header {
          padding: 12px 16px;
          background: transparent;
        }

        .site-header__inner {
          justify-content: space-between;
        }

        .brand__glyph {
          width: 28px;
          height: 28px;
        }

        .brand__name {
          font-size: 1rem;
        }

        .download-chip {
          padding: 8px 14px;
          font-size: 10px;
          letter-spacing: 0.15em;
        }

        .download-chip:focus {
          background: var(--surface-medium);
          border-color: var(--border-strong);
          box-shadow: var(--shadow-sm);
          transform: none;
        }

        .download-chip:active {
          background: var(--surface-medium);
        }

        .cta-button {
          width: 100%;
        }
      }

      /* ========================================
         Responsive — desktop
         ======================================== */
      @media (min-width: 481px) {
        :root {
          --page-max: 520px;
          --page-pad: 32px;
        }

        .quest-icon {
          width: 96px;
          height: 96px;
          font-size: 48px;
          border-radius: 26px;
        }

        .quest-title {
          font-size: 1.8rem;
        }

        .quest-description {
          font-size: 1rem;
        }

        .meta-row {
          padding: 16px 20px;
        }

        .gate-card {
          padding: 28px;
        }
      }

      @media (min-width: 768px) {
        :root {
          --page-max: 560px;
          --page-pad: 40px;
        }

        .quest-icon {
          width: 104px;
          height: 104px;
          font-size: 52px;
          border-radius: 28px;
          margin-bottom: 20px;
        }

        .quest-title {
          font-size: 2rem;
        }
      }

      /* ========================================
         Utility — screen-reader only
         ======================================== */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      /* ========================================
         PHONE GATE — error, loading, success states
         ======================================== */

      /* Error message below input */
      .phone-error {
        font-size: 0.8rem;
        color: var(--accent-error);
        margin: 0 0 8px;
        line-height: 1.4;
      }

      /* Input error state */
      .phone-input--error {
        border-color: var(--accent-error) !important;
        box-shadow: 0 0 0 3px rgba(255, 69, 58, 0.15) !important;
      }

      /* Shake animation for validation error */
      .phone-input-group--shake {
        animation: shake 0.4s ease-in-out;
      }

      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20% { transform: translateX(-6px); }
        40% { transform: translateX(6px); }
        60% { transform: translateX(-4px); }
        80% { transform: translateX(4px); }
      }

      /* Submit button inner elements */
      .phone-submit {
        position: relative;
        overflow: hidden;
      }

      .phone-submit__text {
        transition: opacity 0.2s ease;
      }

      .phone-submit__spinner,
      .phone-submit__check {
        display: none;
      }

      /* Loading state */
      .phone-submit--loading .phone-submit__text { display: none; }
      .phone-submit--loading .phone-submit__spinner {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Success state */
      .phone-submit--success {
        background: var(--accent-success) !important;
        pointer-events: none;
      }

      .phone-submit--success .phone-submit__text { display: none; }
      .phone-submit--success .phone-submit__check {
        display: inline-block;
        font-size: 18px;
        line-height: 1;
      }

      /* Turnstile container spacing */
      #turnstile-container {
        margin: 8px 0;
        display: flex;
        justify-content: center;
        min-height: 0;
        transition: min-height 0.3s ease;
      }

      #turnstile-container:not(:empty) {
        min-height: 65px;
      }

      /* Confirmation fade-in */
      #gate-confirmed:not(.state-hidden) {
        animation: fadeInUp 0.4s ease-out;
      }
    </style>
  </head>
  <body>
    <div class="page-bg" aria-hidden="true"></div>

    <div class="page">
      <!-- ====== Header ====== -->
      <header class="site-header" role="banner">
        <div class="site-header__inner">
          <a class="brand" href="https://thequestsapp.com" aria-label="Quests home">
            <span class="brand__glyph" aria-hidden="true"></span>
            <span class="brand__name">Quests</span>
          </a>
          <a class="download-chip" href="https://apps.apple.com/us/app/quests-social-habit-tracking/id6745767553" target="_blank" rel="noreferrer">Download the app</a>
        </div>
      </header>

      <!-- ====== Main content ====== -->
      <main class="content" role="main">

        <!-- ===== LOADING STATE ===== -->
        <div id="quest-loading" role="status" aria-label="Loading quest details">
          <span class="sr-only">Loading quest details...</span>
          <div class="skeleton-group" style="align-items: center; text-align: center;">
            <div class="skeleton skeleton--icon"></div>
            <div class="skeleton skeleton--title"></div>
            <div class="skeleton skeleton--text" style="margin-top: 4px;"></div>
            <div class="skeleton skeleton--text-short" style="margin-top: 2px;"></div>
          </div>
          <div class="skeleton skeleton--card"></div>
          <div class="skeleton--row">
            <div class="skeleton skeleton--circle"></div>
            <div class="skeleton skeleton--line" style="max-width: 140px;"></div>
          </div>
          <div class="skeleton--row">
            <div class="skeleton skeleton--circle" style="width: 28px; height: 28px;"></div>
            <div class="skeleton skeleton--circle" style="width: 28px; height: 28px; margin-left: -8px;"></div>
            <div class="skeleton skeleton--circle" style="width: 28px; height: 28px; margin-left: -8px;"></div>
            <div class="skeleton skeleton--line" style="max-width: 100px;"></div>
          </div>
          <div class="skeleton skeleton--button"></div>
        </div>

        <!-- ===== QUEST CONTENT (hidden until loaded) ===== -->
        <div id="quest-content" class="state-hidden">

          <!-- Status badge -->
          <div id="quest-status" aria-live="polite">
            <!-- Populated by JS, e.g.:
            <span class="status-badge status-badge--active">
              <span class="status-badge__dot" aria-hidden="true"></span>
              Active
            </span>
            -->
          </div>

          <!-- Hero: icon, title, description -->
          <section id="quest-hero" aria-label="Quest details">
            <div class="quest-icon" id="quest-icon" role="img" aria-label="Quest icon">
              <!-- Populated by JS with emoji or image -->
            </div>
            <h1 class="quest-title" id="quest-title"><!-- Quest Name --></h1>
            <p class="quest-description" id="quest-description"><!-- Quest description --></p>
          </section>

          <!-- Meta rows: date, duration, frequency -->
          <div id="quest-meta" role="list" aria-label="Quest details">
            <div class="meta-row" role="listitem">
              <div class="meta-row__icon" aria-hidden="true">&#128197;</div>
              <div class="meta-row__text">
                <div class="meta-row__label">Starts</div>
                <div class="meta-row__value" id="meta-date">--</div>
              </div>
            </div>
            <div class="meta-row" role="listitem">
              <div class="meta-row__icon" aria-hidden="true">&#9202;</div>
              <div class="meta-row__text">
                <div class="meta-row__label">Duration</div>
                <div class="meta-row__value" id="meta-duration">--</div>
              </div>
            </div>
            <div class="meta-row" role="listitem">
              <div class="meta-row__icon" aria-hidden="true">&#128260;</div>
              <div class="meta-row__text">
                <div class="meta-row__label">Frequency</div>
                <div class="meta-row__value" id="meta-frequency">--</div>
              </div>
            </div>
          </div>

          <!-- Creator -->
          <div id="quest-creator" aria-label="Quest creator">
            <div class="creator-avatar" id="creator-avatar">
              <span class="creator-avatar__fallback" aria-hidden="true">&#128100;</span>
            </div>
            <div class="creator-info">
              <div class="creator-label">Created by</div>
              <div class="creator-name" id="creator-name">--</div>
            </div>
          </div>

          <!-- Social proof -->
          <div id="quest-social" aria-label="Participants">
            <div class="social-avatars" id="social-avatars">
              <!-- Populated by JS -->
            </div>
            <div class="social-text">
              <strong id="social-count">0</strong> <span id="social-label">people joined</span>
            </div>
          </div>

          <!-- Quest ended notice (hidden by default) -->
          <div id="quest-ended" class="state-hidden" role="alert">
            <div class="ended-icon" aria-hidden="true">&#127942;</div>
            <p class="ended-title">This quest has ended</p>
            <p class="ended-text">This quest is no longer accepting new participants. Download Quests to start your own.</p>
          </div>

          <!-- Phone gate (hidden initially, shown after preview loads) -->
          <div id="phone-gate" class="state-hidden">
            <div class="gate-card">
              <!-- Default: phone input form -->
              <div id="gate-form">
                <h2 class="gate-title">Continue in the app</h2>
                <p class="gate-subtitle">Enter your phone number to connect this quest to your account when you sign in.</p>
                <div class="phone-input-group" id="phone-input-group">
                  <label for="phone-input" class="sr-only">Phone number</label>
                  <input
                    id="phone-input"
                    class="phone-input"
                    type="tel"
                    inputmode="tel"
                    autocomplete="tel"
                    placeholder="+1 (555) 000-0000"
                    aria-label="Phone number"
                    aria-describedby="phone-error"
                  />
                  <button class="phone-submit" id="phone-submit" type="button" aria-label="Submit phone number">
                    <span class="phone-submit__text">Submit</span>
                    <span class="phone-submit__spinner" aria-hidden="true"></span>
                    <span class="phone-submit__check" aria-hidden="true">&#10003;</span>
                  </button>
                </div>
                <p id="phone-error" class="phone-error state-hidden" role="alert" aria-live="polite"></p>
                <div id="turnstile-container"></div>
                <p class="gate-privacy">Your number is only used to connect this invite in the app. We never share or sell your data.</p>
              </div>
              <!-- Success state (hidden by default) -->
              <div id="gate-confirmed" class="state-hidden">
                <div class="gate-success">
                  <div class="gate-success__icon" aria-hidden="true">&#10003;</div>
                  <p class="gate-success__title">You're all set</p>
                  <p class="gate-success__text">Download Quests and sign in with this number to join automatically.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Install handoff -->
          <div id="install-handoff">
            <a
              class="cta-button"
              id="download-cta"
              href="https://apps.apple.com/us/app/quests-social-habit-tracking/id6745767553"
              target="_blank"
              rel="noreferrer"
              aria-label="Download Quests on the App Store"
            >
              <span class="cta-button__icon" aria-hidden="true">&#63743;</span>
              Download Quests and Join
            </a>
            <button
              class="link-secondary"
              id="open-app-link"
              type="button"
              aria-label="Open in Quests app if already installed"
            >
              I already have the app
            </button>
          </div>
        </div>

        <!-- ===== ERROR STATE ===== -->
        <div id="quest-error" class="state-hidden" role="alert">
          <div class="error-icon" aria-hidden="true">&#128269;</div>
          <h1 class="error-title" id="error-title">Quest not found</h1>
          <p class="error-text" id="error-text">This quest may have been removed or the link is no longer valid.</p>
          <a
            class="cta-button"
            href="https://apps.apple.com/app/id6745767553"
            target="_blank"
            rel="noreferrer"
            aria-label="Download Quests on the App Store"
          >
            <span class="cta-button__icon" aria-hidden="true">&#63743;</span>
            Download Quests
          </a>
        </div>

      </main>

      <!-- ====== Footer ====== -->
      <footer class="footer" role="contentinfo">
        <p class="footer__text">
          <a class="footer__link" href="https://thequestsapp.com/privacy.html">Privacy</a>
          &nbsp;&middot;&nbsp;
          <a class="footer__link" href="https://thequestsapp.com/terms.html">Terms</a>
          &nbsp;&middot;&nbsp;
          &copy; 2026 Nothing Serious LLC
        </p>
      </footer>
    </div>
    <script>
      (function () {
        // Extract share code from URL path: /q/{shareCode}
        var shareCodeMatch = window.location.pathname.match(/^\/q\/([A-HJ-NP-Za-hj-kmnp-z2-9]{8})$/);
        var shareCode = shareCodeMatch ? shareCodeMatch[1] : '';
        var APP_STORE_URL = 'https://apps.apple.com/us/app/quests-social-habit-tracking/id6745767553';

        // Update smart app banner meta tag with actual share code
        if (shareCode) {
          var metaTag = document.querySelector('meta[name="apple-itunes-app"]');
          if (metaTag) {
            metaTag.setAttribute('content',
              'app-id=6745767553, app-argument=https://invite.thequestsapp.com/q/' + shareCode
            );
          }

          // Update OG canonical URL
          var ogUrl = document.querySelector('meta[property="og:url"]');
          if (ogUrl) {
            ogUrl.setAttribute('content', 'https://invite.thequestsapp.com/q/' + shareCode);
          }
        }

        // "I already have the app" — attempt universal link, fallback to App Store
        var openAppBtn = document.getElementById('open-app-link');
        if (openAppBtn) {
          openAppBtn.addEventListener('click', function () {
            if (!shareCode) {
              window.location.href = APP_STORE_URL;
              return;
            }
            var universalLink = 'https://invite.thequestsapp.com/q/' + shareCode;
            window.location.href = universalLink;

            // If app didn't intercept within 1.5s, redirect to App Store
            setTimeout(function () {
              if (!document.hidden) {
                window.location.href = APP_STORE_URL;
              }
            }, 1500);
          });
        }

        // Dynamic meta tag updates when quest data loads
        // Called by the data-fetch module after API response
        window.__updateQuestMeta = function (questData) {
          if (!questData) return;
          var title = questData.name
            ? 'Join "' + questData.name + '" on Quests'
            : "You're invited to a Quest!";
          var desc = questData.description
            || "Join your friend's quest on Quests - the social habit tracking app";

          document.title = title + ' - Quests';

          var updates = {
            'og:title': title,
            'og:description': desc,
            'twitter:title': title,
            'twitter:description': desc
          };
          for (var key in updates) {
            var el = document.querySelector('meta[property="' + key + '"]')
                  || document.querySelector('meta[name="' + key + '"]');
            if (el) el.setAttribute('content', updates[key]);
          }
        };
      })();
    </script>

    <!-- Quest preview data fetching -->
    <script>
      (function () {
        /* ==========================================
           Quest Preview — Data Fetching & Rendering
           ========================================== */

        // ---- Config (fill before deploy) ----
        var SUPABASE_URL = 'https://bltogjnxwvybhyfaivtw.supabase.co';
        var SUPABASE_PUBLISHABLE_KEY = 'sb_publishable_eC3bie4_CZz3KpbOaLbD3Q_LRodcVw8';
        var FETCH_TIMEOUT_MS = 10000;

        // ---- Share code extraction ----
        function getShareCode() {
          var match = window.location.pathname.match(/^\/q\/([A-HJ-NP-Za-hj-kmnp-z2-9]{8})$/);
          return match ? match[1] : null;
        }

        // ---- State toggles ----
        var $loading = document.getElementById('quest-loading');
        var $content = document.getElementById('quest-content');
        var $error   = document.getElementById('quest-error');

        function showLoading() {
          $loading.classList.remove('state-hidden');
          $content.classList.add('state-hidden');
          $error.classList.add('state-hidden');
        }

        function showContent() {
          $loading.classList.add('state-hidden');
          $content.classList.remove('state-hidden');
          $error.classList.add('state-hidden');
        }

        function showError(title, text) {
          $loading.classList.add('state-hidden');
          $content.classList.add('state-hidden');
          $error.classList.remove('state-hidden');
          document.getElementById('error-title').textContent = title;
          document.getElementById('error-text').textContent = text;
        }

        // ---- Formatting helpers ----
        function formatDateTime(iso) {
          if (!iso) return '--';
          try {
            return new Intl.DateTimeFormat(undefined, {
              weekday: 'short',
              month: 'short',
              day: 'numeric',
              hour: 'numeric',
              minute: '2-digit',
            }).format(new Date(iso));
          } catch (e) {
            return '--';
          }
        }

        function formatDuration(days) {
          if (!days) return '--';
          if (days === 1) return '1 day';
          if (days % 7 === 0) {
            var weeks = days / 7;
            return weeks + ' week' + (weeks > 1 ? 's' : '');
          }
          return days + ' days';
        }

        function formatFrequency(freq) {
          if (!freq) return '--';
          var map = { DAILY: 'Daily', WEEKLY: 'Weekly', MONTHLY: 'Monthly', ONE_TIME: 'One-time' };
          return map[freq] || freq.charAt(0).toUpperCase() + freq.slice(1).toLowerCase();
        }

        function getQuestStatus(data) {
          var now = new Date();
          var end = data.end_time ? new Date(data.end_time) : null;
          var start = data.start_time ? new Date(data.start_time) : null;

          if (data.status === 'COMPLETED' || (end && end < now)) return 'ended';
          if (data.status === 'ACTIVE') return 'active';
          if (data.status === 'UPCOMING' || (start && start > now)) return 'upcoming';
          return 'active';
        }

        // ---- Fetch quest preview from Supabase ----
        function fetchQuestPreview(shareCode) {
          return new Promise(function (resolve, reject) {
            var controller = new AbortController();
            var timeoutId = setTimeout(function () { controller.abort(); }, FETCH_TIMEOUT_MS);

            fetch(SUPABASE_URL + '/rest/v1/rpc/get_quest_preview', {
              method: 'POST',
              headers: {
                apikey: SUPABASE_PUBLISHABLE_KEY,
                'Content-Type': 'application/json',
                Accept: 'application/json',
              },
              body: JSON.stringify({ p_share_code: shareCode }),
              signal: controller.signal,
            })
              .then(function (res) {
                clearTimeout(timeoutId);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json();
              })
              .then(resolve)
              .catch(function (err) {
                clearTimeout(timeoutId);
                if (err.name === 'AbortError') {
                  reject(new Error('timeout'));
                } else {
                  reject(err);
                }
              });
          });
        }

        // ---- Render quest data into DOM ----
        function renderQuest(data) {
          // Icon (emoji)
          var iconEl = document.getElementById('quest-icon');
          iconEl.textContent = data.icon || '';
          if (data.icon_color && /^#[0-9a-fA-F]{6}$/.test(data.icon_color)) {
            iconEl.style.background =
              'linear-gradient(145deg, ' + data.icon_color + '33, ' + data.icon_color + '18)';
          }

          // Title & description
          document.getElementById('quest-title').textContent = data.name || 'Untitled Quest';
          document.getElementById('quest-description').textContent = data.description || '';

          // Meta rows
          document.getElementById('meta-date').textContent = formatDateTime(data.start_time);
          document.getElementById('meta-duration').textContent = formatDuration(data.duration_days);
          document.getElementById('meta-frequency').textContent = formatFrequency(data.frequency);

          // Creator avatar
          var avatarWrap = document.getElementById('creator-avatar');
          var fallbackSpan = avatarWrap.querySelector('.creator-avatar__fallback');
          document.getElementById('creator-name').textContent = data.creator_name || 'Anonymous';

          if (data.creator_avatar && data.creator_avatar.indexOf('https://') === 0) {
            var img = document.createElement('img');
            img.src = data.creator_avatar;
            img.alt = data.creator_name || 'Creator';
            img.onerror = function () {
              img.remove();
              if (fallbackSpan) fallbackSpan.style.display = '';
            };
            if (fallbackSpan) fallbackSpan.style.display = 'none';
            avatarWrap.appendChild(img);
          } else if (data.creator_name && fallbackSpan) {
            fallbackSpan.textContent = data.creator_name.charAt(0).toUpperCase();
          }

          // Social proof — participant count
          var count = data.participant_count || 0;
          document.getElementById('social-count').textContent = count;
          document.getElementById('social-label').textContent =
            count === 1 ? 'person joined' : 'people joined';

          // Placeholder avatar circles
          var avatarsEl = document.getElementById('social-avatars');
          var showCount = Math.min(count, 3);
          for (var i = 0; i < showCount; i++) {
            var circle = document.createElement('div');
            circle.className = 'social-avatar';
            circle.setAttribute('aria-hidden', 'true');
            circle.textContent = '\uD83D\uDC64';
            avatarsEl.appendChild(circle);
          }

          // Status badge
          var status = getQuestStatus(data);
          var statusEl = document.getElementById('quest-status');
          var label = status === 'ended' ? 'Ended'
                    : status === 'upcoming' ? 'Upcoming'
                    : 'Active';
          statusEl.textContent = '';
          var badge = document.createElement('span');
          badge.className = 'status-badge status-badge--' + status;
          var dot = document.createElement('span');
          dot.className = 'status-badge__dot';
          dot.setAttribute('aria-hidden', 'true');
          badge.appendChild(dot);
          badge.appendChild(document.createTextNode(label));
          statusEl.appendChild(badge);

          // Ended quest: show notice, hide phone gate & install handoff
          if (status === 'ended') {
            document.getElementById('quest-ended').classList.remove('state-hidden');
            document.getElementById('phone-gate').classList.add('state-hidden');
            document.getElementById('install-handoff').classList.add('state-hidden');
          } else {
            document.getElementById('quest-ended').classList.add('state-hidden');
            document.getElementById('phone-gate').classList.remove('state-hidden');
          }

          // Update page meta tags via the bootstrap hook
          if (typeof window.__updateQuestMeta === 'function') {
            window.__updateQuestMeta(data);
          }

          showContent();
        }

        // ---- Main init ----
        function init() {
          showLoading();

          var shareCode = getShareCode();
          if (!shareCode) {
            showError(
              'Invalid link',
              'This invite link is not valid. Please check the URL and try again.'
            );
            return;
          }

          fetchQuestPreview(shareCode)
            .then(function (data) {
              if (data && data.error) {
                if (data.error === 'quest_not_found') {
                  showError(
                    'Quest not found',
                    'This quest may have been removed or the link is no longer valid.'
                  );
                } else if (data.error === 'quest_unavailable') {
                  showError(
                    'Quest unavailable',
                    'This quest is no longer available.'
                  );
                } else {
                  showError(
                    'Something went wrong',
                    'We could not load this quest. Please try again later.'
                  );
                }
                return;
              }
              renderQuest(data);
            })
            .catch(function (err) {
              if (err.message === 'timeout') {
                showError(
                  'Request timed out',
                  'Please check your connection and try again.'
                );
              } else {
                showError(
                  'Unable to load quest',
                  'Something went wrong. Please try again later.'
                );
              }
            });
        }

        init();
      })();
    </script>

    <!-- Phone capture flow -->
    <script>
      (function () {
        'use strict';

        /* ============================================
           DOM references
           ============================================ */
        var phoneInput    = document.getElementById('phone-input');
        var phoneSubmit   = document.getElementById('phone-submit');
        var phoneError    = document.getElementById('phone-error');
        var inputGroup    = document.getElementById('phone-input-group');
        var gateForm      = document.getElementById('gate-form');
        var gateConfirmed = document.getElementById('gate-confirmed');
        var turnstileBox  = document.getElementById('turnstile-container');

        /* ============================================
           State
           ============================================ */
        var turnstileToken  = null;
        var turnstileWidget = null;
        var isSubmitting    = false;

        /* ============================================
           Share code from URL
           ============================================ */
        var shareCodeMatch = window.location.pathname.match(/^\/q\/([A-HJ-NP-Za-hj-kmnp-z2-9]{8})$/);
        var shareCode = shareCodeMatch ? shareCodeMatch[1] : '';

        /* ============================================
           Phone formatting & validation
           ============================================ */
        function stripNonDigits(str) {
          return str.replace(/\D/g, '');
        }

        function formatPhoneDisplay(value) {
          var digits = stripNonDigits(value);
          // Strip leading 1 for display formatting (US)
          if (digits.length > 10 && digits.charAt(0) === '1') {
            digits = digits.substring(1);
          }
          if (digits.length > 10) digits = digits.substring(0, 10);

          if (digits.length === 0) return '';
          if (digits.length <= 3) return '+1 (' + digits;
          if (digits.length <= 6) return '+1 (' + digits.substring(0, 3) + ') ' + digits.substring(3);
          return '+1 (' + digits.substring(0, 3) + ') ' + digits.substring(3, 6) + '-' + digits.substring(6);
        }

        function normalizeToE164(value) {
          var digits = stripNonDigits(value);
          // Strip leading 1 if 11 digits
          if (digits.length === 11 && digits.charAt(0) === '1') {
            digits = digits.substring(1);
          }
          if (digits.length !== 10) return null;
          return '+1' + digits;
        }

        /* ============================================
           Input event — auto-format as user types
           ============================================ */
        phoneInput.addEventListener('input', function () {
          var cursor = phoneInput.selectionStart;
          var raw = phoneInput.value;
          var formatted = formatPhoneDisplay(raw);
          phoneInput.value = formatted;

          // Clear error state on new input
          clearError();

          // Approximate cursor position after formatting
          var newCursor = formatted.length;
          if (cursor < raw.length) {
            var digitsBeforeCursor = stripNonDigits(raw.substring(0, cursor)).length;
            var count = 0;
            for (var i = 0; i < formatted.length; i++) {
              if (/\d/.test(formatted.charAt(i))) count++;
              if (count >= digitsBeforeCursor) { newCursor = i + 1; break; }
            }
          }
          phoneInput.setSelectionRange(newCursor, newCursor);
        });

        // Format on paste
        phoneInput.addEventListener('paste', function () {
          setTimeout(function () {
            phoneInput.value = formatPhoneDisplay(phoneInput.value);
          }, 0);
        });

        // Submit on Enter key
        phoneInput.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            handleSubmit();
          }
        });

        /* ============================================
           Error display helpers
           ============================================ */
        function showError(msg) {
          phoneError.textContent = msg;
          phoneError.classList.remove('state-hidden');
          phoneInput.classList.add('phone-input--error');

          // Shake animation
          inputGroup.classList.remove('phone-input-group--shake');
          // Force reflow to restart animation
          void inputGroup.offsetWidth;
          inputGroup.classList.add('phone-input-group--shake');

          phoneInput.focus();
        }

        function clearError() {
          phoneError.classList.add('state-hidden');
          phoneError.textContent = '';
          phoneInput.classList.remove('phone-input--error');
        }

        /* ============================================
           Button state helpers
           ============================================ */
        function setButtonLoading() {
          phoneSubmit.disabled = true;
          phoneSubmit.classList.add('phone-submit--loading');
          phoneSubmit.setAttribute('aria-busy', 'true');
        }

        function setButtonDefault() {
          phoneSubmit.disabled = false;
          phoneSubmit.classList.remove('phone-submit--loading');
          phoneSubmit.classList.remove('phone-submit--success');
          phoneSubmit.setAttribute('aria-busy', 'false');
        }

        function setButtonSuccess() {
          phoneSubmit.classList.remove('phone-submit--loading');
          phoneSubmit.classList.add('phone-submit--success');
        }

        /* ============================================
           Turnstile initialization
           ============================================ */
        function initTurnstile() {
          if (typeof turnstile === 'undefined') return;
          if (turnstileWidget != null) return;

          turnstileWidget = turnstile.render(turnstileBox, {
            sitekey: '0x4AAAAAACaMy8ev_fZjSv2s',
            theme: 'dark',
            callback: function (token) {
              turnstileToken = token;
            },
            'error-callback': function () {
              turnstileToken = null;
            },
            'expired-callback': function () {
              turnstileToken = null;
            }
          });
        }

        // Attempt init when Turnstile script loads; also retry on DOMContentLoaded
        if (typeof turnstile !== 'undefined') {
          initTurnstile();
        } else {
          // The script loads async — poll briefly
          var attempts = 0;
          var pollId = setInterval(function () {
            attempts++;
            if (typeof turnstile !== 'undefined') {
              clearInterval(pollId);
              initTurnstile();
            } else if (attempts > 50) { // ~5 seconds
              clearInterval(pollId);
            }
          }, 100);
        }

        /* ============================================
           Submit handler
           ============================================ */
        function handleSubmit() {
          if (isSubmitting) return;

          // 1. Validate phone
          var phone = normalizeToE164(phoneInput.value);
          if (!phone) {
            showError('Please enter a valid 10-digit phone number.');
            return;
          }

          // 2. Check share code
          if (!shareCode) {
            showError('Invalid invite link.');
            return;
          }

          // 3. Check Turnstile token
          if (!turnstileToken) {
            // Turnstile may not have loaded or may need reset
            if (typeof turnstile !== 'undefined') {
              initTurnstile();
              if (turnstileWidget != null) {
                turnstile.reset(turnstileWidget);
              }
            }
            showError('Verification failed. Please wait a moment and try again.');
            return;
          }

          // 4. Submit
          isSubmitting = true;
          clearError();
          setButtonLoading();

          fetch('/api/link-claims/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              shareCode: shareCode,
              phone: phone,
              turnstileToken: turnstileToken
            })
          })
          .then(function (res) {
            if (res.ok) return res.json().then(function (data) { return { ok: true, data: data }; });

            return res.json().catch(function () { return {}; }).then(function (body) {
              return { ok: false, status: res.status, body: body, headers: res.headers };
            });
          })
          .then(function (result) {
            if (result.ok) {
              onSubmitSuccess(result.data);
            } else {
              onSubmitError(result.status, result.body, result.headers);
            }
          })
          .catch(function () {
            showError('Something went wrong. Please try again.');
            setButtonDefault();
          })
          .finally(function () {
            isSubmitting = false;
          });
        }

        /* ============================================
           Success handler
           ============================================ */
        function onSubmitSuccess(data) {
          setButtonSuccess();

          // Update confirmation text with masked phone if available
          if (data && data.maskedPhone) {
            var successText = gateConfirmed.querySelector('.gate-success__text');
            if (successText) {
              successText.textContent = 'Download Quests and sign in with ' + data.maskedPhone + ' to join automatically.';
            }
          }

          // Brief delay to show checkmark, then transition to confirmed
          setTimeout(function () {
            gateForm.classList.add('state-hidden');
            gateConfirmed.classList.remove('state-hidden');
          }, 600);
        }

        /* ============================================
           Error handler
           ============================================ */
        function onSubmitError(status, body, headers) {
          setButtonDefault();

          // Reset Turnstile for next attempt
          turnstileToken = null;
          if (typeof turnstile !== 'undefined' && turnstileWidget != null) {
            turnstile.reset(turnstileWidget);
          }

          if (status === 429) {
            var retryAfter = headers && headers.get('Retry-After');
            var minutes = retryAfter ? Math.ceil(parseInt(retryAfter, 10) / 60) : 5;
            showError('Too many attempts. Please try again in ' + minutes + ' minute' + (minutes === 1 ? '' : 's') + '.');
            return;
          }

          var errorCode = body && body.error;

          if (status === 404 || errorCode === 'quest_not_found') {
            showError('This quest is no longer available.');
            return;
          }

          if (errorCode === 'quest_unavailable') {
            showError('This quest is no longer accepting participants.');
            return;
          }

          if (errorCode === 'invalid_phone') {
            showError('Please enter a valid phone number.');
            return;
          }

          if (errorCode === 'turnstile_failed') {
            showError('Verification failed. Please try again.');
            return;
          }

          showError('Something went wrong. Please try again.');
        }

        /* ============================================
           Bind submit button
           ============================================ */
        phoneSubmit.addEventListener('click', handleSubmit);
      })();
    </script>
  </body>
</html>
